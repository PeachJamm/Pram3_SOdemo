<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:zeebe="http://camunda.org/schema/zeebe/1.0"
                  id="Definitions_1"
                  targetNamespace="http://pram3.io/bpmn/sales-order"
                  exporter="Camunda Modeler"
                  exporterVersion="5.15.0">

  <bpmn:process id="sales-order-process" name="销售订单审批流程" isExecutable="true">
    
    <bpmn:startEvent id="start-event" name="订单提交">
      <bpmn:outgoing>flow-1</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:userTask id="task-order-validation" name="订单验证">
      <bpmn:extensionElements>
        <zeebe:formDefinition formId="order-validation" />
        <zeebe:userTask />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-1</bpmn:incoming>
      <bpmn:outgoing>flow-2</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:businessRuleTask id="task-determine-approval-level" name="确定审批级别">
      <bpmn:extensionElements>
        <zeebe:calledDecision decisionId="select-approval-level" resultVariable="approvalLevel" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-2</bpmn:incoming>
      <bpmn:outgoing>flow-3</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:businessRuleTask id="task-calculate-discount" name="计算折扣">
      <bpmn:extensionElements>
        <zeebe:calledDecision decisionId="calculate-discount" resultVariable="discountDecision" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-3</bpmn:incoming>
      <bpmn:outgoing>flow-4</bpmn:outgoing>
    </bpmn:businessRuleTask>

    <bpmn:exclusiveGateway id="gateway-approval-path" name="审批路径" default="flow-to-sm">
      <bpmn:incoming>flow-4</bpmn:incoming>
      <bpmn:outgoing>flow-to-sm</bpmn:outgoing>
      <bpmn:outgoing>flow-to-finance</bpmn:outgoing>
      <bpmn:outgoing>flow-to-director</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:userTask id="task-sales-manager" name="销售经理审批">
      <bpmn:extensionElements>
        <zeebe:formDefinition formId="sales-manager-approval" />
        <zeebe:userTask />
        <zeebe:assignmentDefinition assignee="salesmgr01" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-to-sm</bpmn:incoming>
      <bpmn:outgoing>flow-sm-end</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:userTask id="task-finance" name="财务审批">
      <bpmn:extensionElements>
        <zeebe:formDefinition formId="finance-approval" />
        <zeebe:userTask />
        <zeebe:assignmentDefinition assignee="finance01" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-to-finance</bpmn:incoming>
      <bpmn:outgoing>flow-finance-end</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:userTask id="task-director" name="总监审批">
      <bpmn:extensionElements>
        <zeebe:formDefinition formId="director-approval" />
        <zeebe:userTask />
        <zeebe:assignmentDefinition assignee="director01" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-to-director</bpmn:incoming>
      <bpmn:outgoing>flow-director-end</bpmn:outgoing>
    </bpmn:userTask>

    <bpmn:exclusiveGateway id="gateway-approval-result" name="审批结果">
      <bpmn:incoming>flow-sm-end</bpmn:incoming>
      <bpmn:incoming>flow-finance-end</bpmn:incoming>
      <bpmn:incoming>flow-director-end</bpmn:incoming>
      <bpmn:outgoing>flow-approved</bpmn:outgoing>
      <bpmn:outgoing>flow-rejected</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:parallelGateway id="gateway-auto-processing" name="自动处理">
      <bpmn:incoming>flow-approved</bpmn:incoming>
      <bpmn:outgoing>flow-to-inventory</bpmn:outgoing>
      <bpmn:outgoing>flow-to-notification</bpmn:outgoing>
    </bpmn:parallelGateway>

    <bpmn:serviceTask id="task-inventory" name="库存预留">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="inventory-reservation" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-to-inventory</bpmn:incoming>
      <bpmn:outgoing>flow-inventory-done</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:serviceTask id="task-notification" name="通知客户">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="notification" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>flow-to-notification</bpmn:incoming>
      <bpmn:outgoing>flow-notification-done</bpmn:outgoing>
    </bpmn:serviceTask>

    <bpmn:parallelGateway id="gateway-auto-merge" name="自动处理完成">
      <bpmn:incoming>flow-inventory-done</bpmn:incoming>
      <bpmn:incoming>flow-notification-done</bpmn:incoming>
      <bpmn:outgoing>flow-to-end</bpmn:outgoing>
    </bpmn:parallelGateway>

    <bpmn:endEvent id="end-approved" name="订单完成">
      <bpmn:incoming>flow-to-end</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:endEvent id="end-rejected" name="订单拒绝">
      <bpmn:incoming>flow-rejected</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="flow-1" sourceRef="start-event" targetRef="task-order-validation" />
    <bpmn:sequenceFlow id="flow-2" sourceRef="task-order-validation" targetRef="task-determine-approval-level" />
    <bpmn:sequenceFlow id="flow-3" sourceRef="task-determine-approval-level" targetRef="task-calculate-discount" />
    <bpmn:sequenceFlow id="flow-4" sourceRef="task-calculate-discount" targetRef="gateway-approval-path" />
    
    <bpmn:sequenceFlow id="flow-to-sm" name="销售经理审批(默认)" sourceRef="gateway-approval-path" targetRef="task-sales-manager" />
    
    <bpmn:sequenceFlow id="flow-to-finance" name="财务审批" sourceRef="gateway-approval-path" targetRef="task-finance">
      <bpmn:conditionExpression>= approvalLevel = "FINANCE"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="flow-to-director" name="总监审批" sourceRef="gateway-approval-path" targetRef="task-director">
      <bpmn:conditionExpression>= approvalLevel = "DIRECTOR"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="flow-sm-end" sourceRef="task-sales-manager" targetRef="gateway-approval-result" />
    <bpmn:sequenceFlow id="flow-finance-end" sourceRef="task-finance" targetRef="gateway-approval-result" />
    <bpmn:sequenceFlow id="flow-director-end" sourceRef="task-director" targetRef="gateway-approval-result" />

    <bpmn:sequenceFlow id="flow-approved" name="审批通过" sourceRef="gateway-approval-result" targetRef="gateway-auto-processing">
      <bpmn:conditionExpression>= approvalDecision = "APPROVE"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    
    <bpmn:sequenceFlow id="flow-rejected" name="审批拒绝" sourceRef="gateway-approval-result" targetRef="end-rejected">
      <bpmn:conditionExpression>= approvalDecision = "REJECT"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>

    <bpmn:sequenceFlow id="flow-to-inventory" sourceRef="gateway-auto-processing" targetRef="task-inventory" />
    <bpmn:sequenceFlow id="flow-to-notification" sourceRef="gateway-auto-processing" targetRef="task-notification" />
    <bpmn:sequenceFlow id="flow-inventory-done" sourceRef="task-inventory" targetRef="gateway-auto-merge" />
    <bpmn:sequenceFlow id="flow-notification-done" sourceRef="task-notification" targetRef="gateway-auto-merge" />
    <bpmn:sequenceFlow id="flow-to-end" sourceRef="gateway-auto-merge" targetRef="end-approved" />

  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="sales-order-process">
      
      <bpmndi:BPMNShape id="_BPMNShape_start-event" bpmnElement="start-event">
        <dc:Bounds x="152" y="152" width="36" height="36" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-order-validation" bpmnElement="task-order-validation">
        <dc:Bounds x="240" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-determine-approval-level" bpmnElement="task-determine-approval-level">
        <dc:Bounds x="390" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-calculate-discount" bpmnElement="task-calculate-discount">
        <dc:Bounds x="540" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_gateway-approval-path" bpmnElement="gateway-approval-path" isMarkerVisible="true">
        <dc:Bounds x="695" y="145" width="50" height="50" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-sales-manager" bpmnElement="task-sales-manager">
        <dc:Bounds x="820" y="50" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-finance" bpmnElement="task-finance">
        <dc:Bounds x="820" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-director" bpmnElement="task-director">
        <dc:Bounds x="820" y="210" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_gateway-approval-result" bpmnElement="gateway-approval-result" isMarkerVisible="true">
        <dc:Bounds x="975" y="145" width="50" height="50" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_gateway-auto-processing" bpmnElement="gateway-auto-processing" isMarkerVisible="true">
        <dc:Bounds x="1080" y="145" width="50" height="50" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-inventory" bpmnElement="task-inventory">
        <dc:Bounds x="1180" y="80" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_task-notification" bpmnElement="task-notification">
        <dc:Bounds x="1180" y="180" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_gateway-auto-merge" bpmnElement="gateway-auto-merge" isMarkerVisible="true">
        <dc:Bounds x="1330" y="145" width="50" height="50" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_end-approved" bpmnElement="end-approved">
        <dc:Bounds x="1432" y="152" width="36" height="36" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="_BPMNShape_end-rejected" bpmnElement="end-rejected">
        <dc:Bounds x="1080" y="252" width="36" height="36" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNEdge id="Flow_1" bpmnElement="flow-1">
        <di:waypoint x="188" y="170" />
        <di:waypoint x="240" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_2" bpmnElement="flow-2">
        <di:waypoint x="340" y="170" />
        <di:waypoint x="390" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_3" bpmnElement="flow-3">
        <di:waypoint x="490" y="170" />
        <di:waypoint x="540" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_4" bpmnElement="flow-4">
        <di:waypoint x="640" y="170" />
        <di:waypoint x="695" y="170" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_to-sm" bpmnElement="flow-to-sm">
        <di:waypoint x="720" y="145" />
        <di:waypoint x="720" y="90" />
        <di:waypoint x="820" y="90" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_to-finance" bpmnElement="flow-to-finance">
        <di:waypoint x="745" y="170" />
        <di:waypoint x="820" y="170" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_to-director" bpmnElement="flow-to-director">
        <di:waypoint x="720" y="195" />
        <di:waypoint x="720" y="250" />
        <di:waypoint x="820" y="250" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_sm-end" bpmnElement="flow-sm-end">
        <di:waypoint x="920" y="90" />
        <di:waypoint x="1000" y="90" />
        <di:waypoint x="1000" y="145" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_finance-end" bpmnElement="flow-finance-end">
        <di:waypoint x="920" y="170" />
        <di:waypoint x="975" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_director-end" bpmnElement="flow-director-end">
        <di:waypoint x="920" y="250" />
        <di:waypoint x="1000" y="250" />
        <di:waypoint x="1000" y="195" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_approved" bpmnElement="flow-approved">
        <di:waypoint x="1025" y="170" />
        <di:waypoint x="1080" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_rejected" bpmnElement="flow-rejected">
        <di:waypoint x="1000" y="195" />
        <di:waypoint x="1000" y="270" />
        <di:waypoint x="1080" y="270" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_to-inventory" bpmnElement="flow-to-inventory">
        <di:waypoint x="1105" y="145" />
        <di:waypoint x="1105" y="120" />
        <di:waypoint x="1180" y="120" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_to-notification" bpmnElement="flow-to-notification">
        <di:waypoint x="1105" y="195" />
        <di:waypoint x="1105" y="220" />
        <di:waypoint x="1180" y="220" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_inventory-done" bpmnElement="flow-inventory-done">
        <di:waypoint x="1280" y="120" />
        <di:waypoint x="1355" y="120" />
        <di:waypoint x="1355" y="145" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_notification-done" bpmnElement="flow-notification-done">
        <di:waypoint x="1280" y="220" />
        <di:waypoint x="1355" y="220" />
        <di:waypoint x="1355" y="195" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="Flow_to-end" bpmnElement="flow-to-end">
        <di:waypoint x="1380" y="170" />
        <di:waypoint x="1432" y="170" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>

</bpmn:definitions>
